## Comprehensive F.R.E.D. Architecture Design (Clarified)

### Overall System Overview
F.R.E.D. is a local‑first, autonomous humanoid AI assistant. Every query flows through a set of agents whose outputs are combined into “Thoughts,” giving F.R.E.D. the illusion of human memory and intuition. All data—L2 short‑term summaries, L3 long‑term memories, and reminders—reside locally. External searches are optional helpers. Configuration is centralized in `config.py`.

### Core Components

1. **User Input Handling**
   - Accepts chat or speech. If Pi glasses are connected (WebRTC), also provides visual context.
   - Conversation turns are counted to trigger L2 and reminder checks.

2. **Query Router (G.A.T.E.)**
   - Runs first on every user query.
   - Examines the query and recent conversation summaries.
   - Returns a JSON object:

     ```json
     {
       "needs_memory": true|false,
       "needs_web_search": true|false,
       "needs_deep_research": true|false,
       "needs_pi_tools": true|false,
       "needs_reminders": true|false
     }
     ```

   - These flags decide which agents the dispatcher activates.

3. **Agent Dispatch System**
   - Spawns each required agent in its own thread (no additional per‑thread timeouts).
   - Maximum parallel agents controlled by `MAX_CONCURRENT_AGENTS` in `config.py`.
   - Any agent failure generates a natural notice for F.R.E.D. (e.g., “My memory isn’t working right now”).

4. **Agents**

   - **C.R.A.P. (Context Retrieval for Augmented Prompts)** – Memory recall. Pulls L2 short‑term memories and relevant L3 facts. Adds the single most relevant L2 summary plus the most recent summary. If C.R.A.P. runs, its output flows through S.Y.N.A.P.S.E. before reaching F.R.E.D.

   - **S.C.O.U.T. (Swift Contextual Online Utility Tool)** – Quick web lookup. Performs one search attempt and returns a short insight (one or more sentences) with a 0–100 confidence score. If confidence <70%, it automatically calls `elevate_to_deep_research` to add the query to the agenda.

   - **R.E.M.I.N.D. (Recall Events Memory Injection for Notifications Delivery)** – Reminder manager. Parses conversation for schedule or task requests, supporting full CRUD. Timestamps use ISO format. Active reminders are injected into the FRED Database every turn until acknowledged, and F.R.E.D. brings them up at an opportune moment.

   - **P.I.V.O.T. (Pi Integration for Visual Observation Tasks)** – Pi‑only actions. Currently limited to `enroll_person` when the glasses are connected.

5. **Synthesis Agent (S.Y.N.A.P.S.E. - Synthesis Yielding Natural Augmented Prompts for Seamless Engagement)**
   - Runs every turn.
   - Gathers outputs from all active agents (including L2-only routes).
   - Produces bullet points as “Fleeting Thoughts:”  
     - Each bullet references a memory, web lookup, or reminder.  
     - Final bullet: “Putting it together…” summarizing the combined insight.
   - This Thoughts block becomes F.R.E.D.’s internal context.

6. **F.R.E.D. (Funny Rude Educated Droid) Core**
   - Receives the Thoughts from S.Y.N.A.P.S.E. and any Pi visual description.
   - Responds as a sarcastic but helpful assistant. Agent outputs are phrased as his own memories or observations—never mentioning the agents.
   - When agenda research completes, F.R.E.D. says “I looked into it while you were away…” before sharing the findings.

7. **L2 Memory Handling**
   - L2 summaries are always routed through S.Y.N.A.P.S.E.  
     - If C.R.A.P. is triggered, L2 feeds into C.R.A.P. first, then S.Y.N.A.P.S.E.  
     - If not, L2 goes straight to S.Y.N.A.P.S.E.
   - C.R.A.P. also adds any highly relevant L3 memories.

8. **Background Processes**
   - **Agenda & Deep Research** – Tasks from S.C.O.U.T. with low confidence (<70%) or direct user requests run offline via ARCH/DELVE. Results appear later in conversation as F.R.E.D.’s recollections.
   - **Memory Consolidation** – Periodically moves older L2 memories into L3.
   - **Reminder Cleanup** – After a reminder is acknowledged, R.E.M.I.N.D. deletes it from the database.

9. **Error & Timeout Handling**
   - Global timeouts are defined in `config.py`. If any agent fails, F.R.E.D. mentions the issue in natural language but continues with available context.

10. **Persona Rules**
    - F.R.E.D. treats agent outputs as his own memories. He never references the agents by name.
    - When presenting finished research he says it was done “while you were away.”

### Full Process Flow

1. User sends a query.
2. G.A.T.E. returns routing flags.
3. Dispatcher launches the necessary agents in parallel threads.
4. Agents finish and send their outputs to S.Y.N.A.P.S.E.
5. S.Y.N.A.P.S.E. compiles “Fleeting Thoughts” bullets.
6. F.R.E.D. reads the Thoughts (and any visual context) and crafts a response.
7. Completed reminders or research tasks are mentioned naturally.
8. Background tasks (agenda research, memory consolidation) run between turns.

This clarified plan ensures each agent’s role is unambiguous, L2 context always flows through S.Y.N.A.P.S.E., reminders persist until acknowledged, and deep research triggers automatically from low-confidence web lookups. The overall system provides a cohesive humanoid experience while remaining fully local.