1. Core Flow
User Input Handling

Accepts chat or speech. If Pi glasses are connected via WebRTC, an image frame is processed by the Vision agent and the resulting description is injected into the FRED DATABASE.

Query Router (G.A.T.E.)

Examines the user query and recent conversation summaries.

Produces a JSON with flags: needs_memory, needs_web_search, needs_deep_research, needs_pi_tools, needs_reminders.

If needs_deep_research is flagged or S.C.O.U.T. escalates, the task is added to the agenda queue for processing during the next sleep cycle.

Agent Dispatch System

Launches required agents in parallel threads (up to MAX_CONCURRENT_AGENTS in config.py).

On failure or timeout, each agent produces an error string which F.R.E.D. can phrase naturally (e.g., “My memory isn’t working right now”).
These error strings are customizable via new constants in config.py and are printed to the console for troubleshooting.

Agents

C.R.A.P.

Retrieves L2 summaries and relevant L3 memories.

It always injects the most recent L2 summary and one additional L2 summary that has the highest semantic similarity to the user’s query. No minimum similarity threshold is required; simply choose the top-scoring summary.

Additional L3 memories are retrieved if their similarity is above L2_RETRIEVAL_THRESHOLD.

S.C.O.U.T.

Performs a single quick web search.

Produces a 0–100 confidence score, estimated by the LLM, for its short answer.

If confidence <70, it automatically calls elevate_to_deep_research to add the query to the agenda.

R.E.M.I.N.D.

Monitors conversation text for scheduling or task language (e.g., “remind me to,” “schedule,” dates/times).

Reminders persist in the database until the user says anything that implies acknowledgment—e.g., “thanks,” “got it,” or “okay.”

Acknowledged reminders are deleted automatically.

P.I.V.O.T.

Handles Pi‑specific commands (currently enroll_person only).

S.Y.N.A.P.S.E.

Runs every turn.

Receives outputs from all active agents plus L2 summaries.

Generates a Fleeting Thoughts block of bullet points that read like F.R.E.D.’s own passing thoughts:

Bullets may mention recalled memories, web lookups, reminders, or visual observations.

The final bullet is always “Putting it together…” summarizing the overall insight.

The entire block forms the FRED DATABASE portion of the prompt.

F.R.E.D. Core

Receives the user text plus FRED DATABASE.

Responds with a short, sarcastic but helpful answer, never mentioning agents.

If new research findings are available from the agenda system, he begins with “I looked into it while you were away…” before explaining.

Background Processes

Agenda & Deep Research

Items queued from S.C.O.U.T. or user requests run during the next sleep cycle.

Results are stored automatically in L3 memory. A “Done” list maps agenda items to their resulting node IDs so F.R.E.D. can mention them later.

Memory Consolidation

Periodically moves older L2 summaries to L3.

Reminder Cleanup

Removes acknowledged reminders from the database.

Visual Context Injection

The Vision agent outputs a short scene description (2–3 sentences).

This description is inserted into the FRED DATABASE together with memory and reminder bullets so that F.R.E.D. perceives it as part of his own recollection.

2. Prompt Structure (“Humanoid” Style)
A typical prompt to F.R.E.D. now resembles:

[User query or previous dialog]

(FRED DATABASE)
• [Memory or reminder bullet]
• [Web lookup insight]
• [Visual observation, if any]
• Putting it together... [short summary]
(END FRED DATABASE)
The bullet list reads like fleeting thoughts F.R.E.D. is recalling in his mind, reinforcing the illusion that he is accessing personal memories.

3. Configuration Updates (config.py)
Add strings for customizable error messages, e.g.:

AGENT_ERRORS = {
    "memory_failure": "My memory isn't working right now.",
    "search_failure": "The web search failed."
}
Ensure MAX_CONCURRENT_AGENTS and any new constants are set here.

4. Open Questions Resolved
L2 Summary Selection: Always include the latest summary plus whichever summary has the highest semantic similarity; no additional filtering threshold is required.

S.C.O.U.T. Elevation: Confidence <70 triggers elevate_to_deep_research automatically.

Reminder Parsing: Based on conversation text. A simple “thanks” counts as acknowledgment.

S.Y.N.A.P.S.E. Bullets: Format as F.R.E.D.’s own thoughts. No fixed ordering beyond the final “Putting it together…” bullet.

Deep Research Queue: Unlimited tasks. They run during sleep cycles and results are stored in L3 with references in a “Done” list.

Error Messages: Customizable via config.py, logged to console for debugging.

Visual Context: Injected into the FRED DATABASE bullet list so F.R.E.D. perceives it as a memory.

This finalized plan specifies every design choice necessary for implementation and aligns the entire system with the desired “humanoid” style of F.R.E.D.’s behavior.